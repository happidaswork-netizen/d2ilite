# D2I Lite 模板生成与使用 SOP

本文档是“可执行版”操作手册，目标是让模板生成、交付、使用、验收都有统一动作，避免因模板差异导致抓取失败、漏抓、错图或任务卡死。

适用范围：
- `d2ilite/scraper/templates/*.json` 模板新增/修改
- 公共抓取（通用）GUI 与 `run_public_scraper.py` 命令行
- 年份版页面、分栏目页面、多层目录页面

---

## 1. 你给我一个链接后，我必须做什么

### 1.1 输入确认（必须先确认）

你给出 URL 后，先固定 5 个输入：
- 入口链接：列表页/栏目页/首页
- 抓取范围：只抓当前栏目，还是连同下级栏目
- 目标字段：至少姓名、详情链接、图片链接；是否要求职称/单位/简介等
- 输出要求：是否按单位建子目录、是否只保留最终图片
- 验收口径：目标总数按“页面真实总数”还是“本次范围内可见总数”

若你未明确，默认策略：
- 只抓当前栏目及其分页
- 必填 `name + detail_url + image_url`
- 开启低速 + 自动回退浏览器

### 1.2 页面勘察（必须留痕）

至少检查：
- 列表页 2-3 页
- 详情页 5-10 条
- 是否存在 JS 写入（`document.write`）、挑战页、反爬重定向
- 年份入口/栏目入口是否混在同一导航

输出一份“勘察结论”到验证文档中：
- 列表选择器候选
- 详情主容器候选
- 图片候选
- 分页候选
- 反爬风险评估（低/中/高）

### 1.3 先产模板，再实测

流程必须是：
1. 先写模板（不直接全量跑）
2. 小样本结构轮（10-20 条）
3. 模式轮（`requests_jsl` 与 `browser` 各跑至少一次小样）
4. 准生产轮（100 条或全量，取较小者）
5. 出推荐模式与备选模式

---

## 2. 模板编写硬规则（必须遵守）

### 2.1 文件与命名

- 目录：`scraper/templates/`
- 文件名：`机构_栏目.json`（中文可读）
- `site_name`：英文小写 snake_case
- `allowed_domains`：仅保留目标域名

### 2.2 必填字段

`rules.required_fields` 默认固定为：
- `name`
- `detail_url`
- `image_url`

不要把 `field.xxx` 放进 `required_fields`。

### 2.3 选择器优先级

每个关键 selector（`detail_name/detail_image/detail_summary`）都要按“强 -> 弱”排序：
- 第一位：详情主体内高置信命中
- 后续位：通用兜底（`title`/`og:image` 等）

禁止把站点公共头部选择器放在第一位。

### 2.4 自定义字段

自定义字段统一进入：
- `selectors.list_fields`
- `selectors.detail_fields`

显示名统一维护：
- `selectors.detail_field_labels`
- `rules.detail_field_labels`（保持一致）

映射统一在 `rules.field_map` 完成。

### 2.5 图片与命名（卡死问题关键）

强制规则：
- 最终图片按“姓名”命名
- 同名自动 `_2/_3` 去重
- 仅当姓名缺失才允许回退其他命名

原因：
- 监控面板点击“已完成条目”依赖记录与图片一致性
- 非姓名命名（哈希/序号）容易导致错配、打开异常、界面卡顿

---

## 3. 2020 / 2021 这类差异，如何处理

结论先行：只要 DOM 结构、列表组织、字段语义明显变化，就拆成两个模板，不强行合并。

### 3.1 公安英烈墙 2020 vs 2021（当前项目实战）

- 2020 模板：`scraper/templates/mps_yinglie_qingming2020.json`
- 2021 模板：`scraper/templates/mps_yinglie_qingming2021.json`

关键差异：
- 入口不同：
  - 2020：`/n6865805/n7047625/`
  - 2021：`/n7634837/n7797754/`
- 列表结构不同：
  - 2020：`a[href*='/n7047637/'][href*='/content.html']`
  - 2021：`div.main1 dl dd a[href*='/content.html']`
- 分组信息来源不同：
  - 2020 主要从详情页提取 `region`
  - 2021 同时提取 `region + list_region`
- 详情主容器不同：
  - 2020 偏 `box10`
  - 2021 偏 `content_con`
- 年份标识不同：
  - `rules.year_hint` 分别为 `2020`、`2021`

为什么必须拆模板：
- 若硬合并，选择器会互相污染，导致命中率下降
- 年份口径和目录输出会混乱，难以验收

### 3.2 通用“是否拆模板”判定

满足任一条件就拆：
- 列表 selector 改动大于 30%
- 详情主容器类名/结构明显变化
- 字段语义变化（如新增“列表分组”、年份标签）
- 分页机制不同（静态页码 vs 动态加载）
- 反爬机制不同（某年份有挑战，某年份没有）

---

## 4. 模式推荐与出厂要求

### 4.1 模式不是拍脑袋，必须实测后给推荐

每个模板交付必须给出：
- 推荐模式（`requests_jsl` 或 `browser`）
- 备选模式
- 切换条件（例如：403/429 连续出现、图片失败率 > 10%）

### 4.2 推荐策略

- 优先 `requests_jsl`：
  - 页面静态、图片链路稳定、无明显挑战
- 优先 `browser`：
  - JS 渲染重、反爬强、图片防盗链明显
- 推荐启用：
  - `rules.auto_fallback_to_browser = true`

### 4.3 进度口径（统一）

验收看“下载进度”为主，不只看“发现进度”：
- 总目标（expected）
- 已发现（discovered）
- 已下载（downloaded）
- 已完成（completed）

---

## 5. 你日常怎么使用（GUI）

### 5.1 新任务

1. 打开“公共抓取(通用)”
2. 选择模板
3. 选择模式（请求/浏览器）
4. 启动任务
5. 观察右侧日志与下载进度

### 5.2 继续任务时改模式（重点）

继续任务时可以重新选择模式：
- 请求模式(快)
- 浏览器模式(慢稳)
- 是否启用“请求失败自动回退浏览器”

建议：
- 若当前任务失败集中在图片下载或挑战页，继续时切到浏览器模式
- 若浏览器模式过慢且站点稳定，可改回请求模式

### 5.3 点击已完成条目卡死时先查什么

先排查 3 项：
- 图片是否按姓名命名
- `local_image_path` 是否存在且可打开
- 记录中的姓名与图片文件是否一一对应

若命名错了，优先修模板，不要只靠手工改文件名。

---

## 6. 链接交付后的标准产物（我必须给你的）

每次你给一个链接，最终交付至少包含：
- 模板 JSON（`scraper/templates/xxx.json`）
- 验证文档（`docs/template_validation_xxx_日期.md`）
- 推荐模式 + 备选模式 + 切换条件
- 计数口径：
  - 模板预期总数
  - 本次已发现
  - 本次已下载
  - 本次已完成
- 已知风险与失败类型说明（例如挑战页、无图详情）

---

## 7. 验收清单（上线前逐条打勾）

- 模板文件可运行且在 `scraper/templates/`
- `list_item/name/detail_link` 命中稳定
- `detail_name/detail_image/detail_summary` 命中稳定
- 自定义字段命中符合页面事实
- 图片按姓名命名且重名去重正常
- “已完成条目”点击可稳定打开图片
- 验证文档包含 expected/discovered/downloaded/completed
- 推荐模式有实测依据，不是主观判断

---

## 8. 常见错误与处理

问题：只抓到一小部分（例如只抓到 15 个）
- 处理：检查是否漏掉多层入口/子栏目；必要时扩展 `start_urls` 或做栏目聚合

问题：几十个失败
- 处理：先看失败类型分布（挑战、超时、非图片响应）；再决定是否切浏览器模式

问题：已经开始任务但模式选错
- 处理：暂停 -> 继续任务 -> 在继续任务弹窗中改模式，不必手工改模板

问题：过程产物太多
- 处理：使用 `rules.direct_write_images=true` + `output_mode=images_only_with_record`，减少中间缓存目录

问题：年份模板混用
- 处理：按年份拆模板，并在 `site_name`、`year_hint`、输出目录中显式区分

---

## 9. 建议的交互模板（你给链接后）

你给链接后，按下面格式给我即可：

```text
目标链接: <url>
抓取范围: 仅当前栏目 / 包含子栏目
目标字段: 姓名, 单位, 职称, 简介, 图片
输出要求: 按单位建目录 / 只要最终图片+记录
验收口径: 目标总数按页面实时统计
```

我会按本 SOP 返回：
- 模板路径
- 验证文档路径
- 推荐模式
- 计数结果与差异说明

---

## 10. 关联文档

- `docs/抓取页面与模板生成规范.md`（规则总纲）
- `docs/template_validation_imech_people_2026-03-01.md`（验证文档示例）
- `scraper/README.md`（运行参数与输出说明）
