# D2I Lite 抓取页面与模板生成规范

本文档用于统一“页面抓取 + 模板生成 + 元数据字段设计”的执行标准，确保每次新增模板都可复用、可验证、可维护。

> 重要原则（强制）  
> 模板是抓取成功率的核心资产。未经过多轮实测和验收的模板，不允许作为正式模板交付。

## 1. 目标与交付

目标:
- 从公开页面稳定抓取人物列表/详情/图片。
- 生成可直接运行的模板 JSON（放在 `scraper/templates/`）。
- 输出高质量元数据，包含基础字段和业务自定义字段。

交付物:
- 一个可运行模板文件（`.json`）。
- 模板关键字段说明（特别是自定义字段）。
- 抽样验证结果（命中率/缺失情况）。
- 可直接执行的运行命令。
- 一份模板验证记录（推荐写入 `docs/`），至少包含:
  - 目标总数（expected）
  - 已发现数（discovered）
  - 已完成数（done）
  - `name/detail_url/image_url` 缺失统计
  - 推荐模式（`requests_jsl` 或 `browser`）及理由

## 2. 输入要求

生成模板前，至少要有:
- 目标站点或入口 URL（如人物列表页）。
- 抓取范围（仅某栏目 / 全站）。
- 元数据重点字段（例如姓名、职称、单位、科室、简介、上下篇关系等）。
- 输出约束（是否需要自动建子目录、命名规则、是否启用 LLM 增强）。

如果用户未明确，默认:
- 仅抓目标栏目。
- 必填字段采用 `name + detail_url + image_url`。
- 开启低速安全参数与失败回退。

## 3. 硬性规则

### 3.1 抓取规则

- 优先低速、可恢复: `concurrent_requests=1`，合理 `download_delay`，开启重试。
- 允许失败回退: `rules.auto_fallback_to_browser=true`。
- 防止分页死循环: `next_page` 选择器必须可去重、可过滤 `javascript:`。
- 站点若存在 `document.write(...)` 包裹 HTML，启用:
  - `selectors.list_response_transform = "document_write_html"` 或
  - `selectors.detail_response_transform = "document_write_html"`。

### 3.2 模板规则

- 模板放置: `scraper/templates/`。
- 文件名规范: `机构_栏目.json`（中文可读）。
- `site_name` 规范: 小写英文 snake_case。
- `allowed_domains` 必须限制到目标域名。
- `required_fields` 默认保留:
  - `"name"`, `"detail_url"`, `"image_url"`。
- 模板必须可解释:
  - 每个关键 selector 都要能说明“为什么选它而不是其他候选”；
  - `detail_name` 禁止使用容易命中站点公共头部的宽泛选择器（如裸 `h1::text`）。

注意:
- `required_fields` 检查的是记录顶层字段（不是 `fields.xxx`）。
- 不要把 `field.xxx` 直接放进 `required_fields`。

### 3.3 元数据规则

- `selectors.list_fields`: 放列表卡片字段（如列表职称、列表摘要）。
- `selectors.detail_fields`: 放详情页自定义字段（核心业务字段优先放这里）。
- `rules.field_map`: 把抓取字段映射到标准目标字段。
- 字段显示名统一放在:
  - `selectors.detail_field_labels`，
  - 同步到 `rules.detail_field_labels`（便于 UI 和写入阶段一致）。

### 3.4 命名与监控联动规则（新增硬性要求）

- 最终图片文件名必须“以人物姓名为中心”：
  - 首选 `row.name`（人物姓名）；
  - 同名冲突时自动追加 `_2`, `_3`；
  - 仅当姓名为空时才允许退化到其他值。
- 禁止默认用哈希、纯序号、无语义标题作为最终命名策略。
- `field_map.person` 必须可稳定回填到姓名来源（通常映射 `name`），避免后续命名漂移。
- 监控面板“已完成条目”点击打开依赖 `local_image_path` 与人物记录一致性；命名策略不一致会导致错配、重复打开或界面卡顿。

## 4. 标准执行流程

### 步骤 0: 模板多轮验证（强制）

每个模板至少执行 3 轮，不允许“一次成功即交付”：

- 第 1 轮（结构轮）:
  - 小样本 10-20 条；
  - 目标: 验证列表/详情/分页 selector 是否正确。
- 第 2 轮（模式轮）:
  - 同一模板分别跑 `requests_jsl` 与 `browser`（至少各 1 次小样）；
  - 目标: 比较图片成功率、耗时、稳定性，给出推荐模式。
- 第 3 轮（准生产轮）:
  - 至少 100 条或全量（取较小者）；
  - 目标: 验证中断恢复、重试、命名一致性、监控可用性。

未满足以上三轮验证，模板状态应标记为“待验证”，不得作为默认模板。

### 步骤 1: 页面结构解析

- 确认列表项节点 `list_item`。
- 确认详情链接 `detail_link`。
- 确认分页 `next_page`。
- 打开 2-3 个列表页与 5-10 个详情页做结构抽样，避免只看单页。

### 步骤 2: 选择器设计

优先级:
- 先用稳定 CSS 选择器。
- 对复杂场景补 XPath。
- 选择器按“强 -> 弱”顺序排列，前面的命中优先。

关键字段建议:
- `name`: 标题文本 + 图片 alt 兜底。
- `detail_name`: 详情主标题 + `title` 兜底。
- `detail_image`: 主图容器 + 通用 `img`/`og:image` 兜底。
- `detail_summary`: `p::text` + 富文本 `p *::text`。
- `detail_full_text`: 详情正文 `*::text`，为空时系统会回退整页正文。

### 步骤 3: 字段映射设计

`field_map` 常用目标键:
- `person`
- `position`
- `unit`
- `department`
- `city` / `location`
- `email`
- `summary`
- `full_content`

`field_map` 常用来源 token:
- 内置: `name`, `gender`, `summary`, `full_content`, `detail_url`, `list_url`, `source_url`, `image_url`
- 自定义字段: `field.xxx`（来自 `list_fields/detail_fields`）

推荐映射例子:
- `position <- field.title`
- `unit <- field.department_text`
- `summary <- summary`
- `full_content <- full_content`

### 步骤 4: 输出与目录策略

常用配置:
- `rules.auto_unit_subdir = true`
- `rules.unit_name = "机构名"`
- `rules.output_subdir_pattern = "{unit}_栏目名"`
- `rules.output_mode = "images_only_with_record"`
- `rules.direct_write_images = true`（推荐：图片直写，不生成 `downloads/images` 缓存目录，过程更干净）
- `rules.keep_record_file = true`

### 步骤 5: 质量验证

至少做一次抽样验证:
- 列表命中数 > 0。
- 详情页可打开且可抽取姓名。
- `image_url` 缺失率可接受（建议接近 0）。
- `summary` 不能大面积为空。
- 自定义字段命中符合页面实际（例如上下篇链接不是每页都有）。
- 人名命名一致性:
  - 抽样 10 条记录，`local_image_path` 文件名应与姓名一致（允许 `_2/_3` 后缀）。
  - 在监控面板点击“已完成条目”，应能稳定打开对应图片，不出现明显卡死。
- 计数一致性（必须记录）:
  - `目标总数 / 已发现 / 已完成` 三个数必须可追溯；
  - 若 `已发现 != 模板预期总数`，需要在交付说明中写清原因（分页限制、过滤规则、站点变更等）。

建议验证口径:
- 抽样 8-20 个详情页。
- 输出:
  - `image_url` 缺失数
  - `summary` 缺失数
  - 每个 `detail_fields` 的命中次数
  - 姓名命中正确率（是否为真实人名）
  - 点击“已完成条目”打开成功率

### 步骤 6: 运行确认

运行命令:

```powershell
.\.venv\Scripts\python .\scraper\run_public_scraper.py --config .\scraper\templates\你的模板.json
```

若仅验证抓取链路，可先小范围执行后再全量跑。

## 5. 自定义字段设计原则

优先高价值字段:
- 组织关系: 科室/单位/机构。
- 身份属性: 职称/岗位/级别。
- 溯源字段: 页面标题、meta 关键词、meta 描述。
- 邻接关系: 上一篇/下一篇姓名与链接。

命名规范:
- 字段 key 使用英文 snake_case。
- 字段 label 使用中文业务名。
- 避免含糊命名（如 `info1`, `data2`）。

## 6. 常见问题与处理

问题: 列表有内容但 `list_item=0`
- 处理: 检查是否是 JS 写入，必要时启用 `document_write_html`。

问题: 分页重复抓取或卡住
- 处理: `next_page` 只取“下一页/页码链接”，过滤 `javascript:`，依赖队列去重。

问题: 详情简介为空
- 处理: 同时配置 `p::text` 与 `p *::text`，必要时补 `div.content::text`。

问题: 图片下载失败或防盗链
- 处理: 设置 `default_headers`/`image_headers` 的 `Referer`，并开启 `image_referer_from_detail_url`。

问题: 请求模式不稳定
- 处理: 维持低速参数，开启 `auto_fallback_to_browser`，必要时直接用 `browser` 模式。

问题: 点击“已完成条目”后界面卡死或打开错图
- 处理:
  - 先检查最终文件是否按“姓名”命名；
  - 检查 `profiles.jsonl / metadata_write_results.jsonl` 中姓名与 `local_image_path` 是否一致；
  - 若历史数据命名不规范，对选中条目执行重试，触发重新写元数据与按姓名重命名。

问题: 模板看起来能跑，但姓名/图片经常错位
- 处理:
  - 优先排查 `detail_name` / `detail_image` 是否用了页面公共区域 selector；
  - 把宽泛 selector 下沉到低优先级，优先使用详情主体容器 selector；
  - 对 10 条样本做“姓名-详情链接-图片路径”三元组人工核对。

问题: 选择推荐模式时不确定用请求模式还是浏览器模式
- 处理:
  - 必须实测两种模式（至少小样各一次）；
  - 以“图片成功率优先、速度次之”作为决策；
  - 交付时明确写出推荐模式和备选模式切换条件。

## 7. 交付检查清单

- 模板文件已创建在 `scraper/templates/`。
- `site_name`、`allowed_domains`、`start_urls` 正确。
- `list_item/name/detail_link/next_page` 全部可命中。
- `detail_name/detail_image/detail_summary` 可稳定抽取。
- `detail_fields + detail_field_labels` 完整。
- `field_map` 已覆盖核心元数据目标。
- 最终图片已按“姓名 + 去重后缀”命名（非哈希主命名）。
- 监控面板点击“已完成条目”可稳定打开图片、无明显卡顿。
- 抽样验证结果已记录（含缺失统计）。
- 三轮验证记录已完成（结构轮/模式轮/准生产轮）。
- 推荐模式已给出且有实测依据（成功率、失败类型、耗时）。
- 提供可执行命令与已知风险说明。

## 8. 参考文件

- `scraper/config.template.generic.json`
- `scraper/config.example.json`
- `scraper/README.md`
- `scraper/run_public_scraper.py`
